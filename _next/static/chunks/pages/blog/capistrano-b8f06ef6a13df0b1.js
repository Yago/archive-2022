(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8517],{9549:function(e,n,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/blog/capistrano",function(){return s(37574)}])},37574:function(e,n,s){"use strict";s.r(n),s.d(n,{default:function(){return c},meta:function(){return a}});var r=s(85893),i=s(11151),t=s(47439);let a={path:"/blog/capistrano",title:"Capistrano",date:"2013-05-28T05:34:59.000Z",type:"post",description:'Il existe plusieurs frameworks de d\xe9ploiement et Capistrano est surement l\'un des plus connus. Avec un simple "cap deploy", vos derni\xe8res mises \xe0 jour seront automatiquement envoy\xe9es via SSH sur votre serveur de production. Il n\xe9cessite cependant une petite installation, mais rien en comparaison du temps que vous allez gagner.'},l=e=>{let{children:n}=e;return(0,r.jsx)(t.Z,{meta:a,children:n})};function o(e){let n={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"Avant, pour mettre mon site en ligne, je devais envoyer mes fichiers via FTP, r\xe9gler la config en ligne, faire un Dump de ma base de donn\xe9es et la r\xe9importer dans la DB distante, mais \xe7a, c'\xe9tait avant."}),"\n",(0,r.jsxs)(n.p,{children:["Il existe plusieurs frameworks de d\xe9ploiement et ",(0,r.jsx)(n.a,{href:"https://github.com/capistrano/capistrano",children:"Capistrano"}),' est surement l\'un des plus connus. Avec un simple "cap deploy", vos derni\xe8res mises \xe0 jour seront automatiquement envoy\xe9es via SSH sur votre serveur de production. Il n\xe9cessite cependant une petite installation, mais rien en comparaison du temps que vous allez gagner.']}),"\n",(0,r.jsx)(n.h2,{children:"Quelques pr\xe9requis"}),"\n",(0,r.jsx)(n.p,{children:"Pour utiliser Capistrano, il vous faut :"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Un acc\xe8s SSH \xe0 votre serveur avec votre clef publique"}),"\n",(0,r.jsx)(n.li,{children:"Une version de Ruby sup\xe9rieur \xe0 1.3.0"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ gem -v\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["L'utilisation de ",(0,r.jsx)(n.a,{href:"http://git-scm.com/",children:"Git"})," dans votre projet (pas obligatoire, mais vivement recommand\xe9)"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{children:"Installation"}),"\n",(0,r.jsx)(n.p,{children:"Pour installer Capistrano et ses extensions :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ gem install capistrano\n$ gem install capistrano-ext\n$ gem install railsless-deploy\n"})}),"\n",(0,r.jsx)(n.p,{children:"Ensuite, allez dans votre r\xe9pertoire et lancez Capistrano :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ cd path/to/your/directory/\n$ capify .\n"})}),"\n",(0,r.jsx)(n.h2,{children:"Comment \xe7a fonctionne en fait ?"}),"\n",(0,r.jsx)(n.p,{children:"Capistrano ne va pas simplement envoyer vos fichiers sur votre serveur, il va \xe9galement cr\xe9er une arborescence destin\xe9e \xe0 versionner votre site. De ce fait et en cas de probl\xe8me, Capistrano vous permettra de retourner \xe0 la version pr\xe9c\xe9dente en une fraction de seconde."}),"\n",(0,r.jsxs)(n.p,{children:["En soit, la structure est relativement simple. \xc0 la racine de votre r\xe9pertoire, il va cr\xe9er un r\xe9pertoire ",(0,r.jsx)(n.strong,{children:"shared"})," pour tous les fichiers partag\xe9s, un r\xe9pertoire ",(0,r.jsx)(n.strong,{children:"releases"})," pour toutes les versions de votre site et un lien symbolique ",(0,r.jsx)(n.strong,{children:"current"})," qui pointera vers la derni\xe8re release."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"monSite\n├── current -> /home/monSite/releases/20130527070530\n├── releases\n│\xa0\xa0 ├── 20130527065508\n│\xa0\xa0 ├── 20130527065907\n│\xa0\xa0 └── 20130527070530\n└── shared\n"})}),"\n",(0,r.jsx)(n.h2,{children:"Le script de d\xe9ploiement"}),"\n",(0,r.jsxs)(n.p,{children:["Capistrano n'est qu'un ex\xe9cuteur. Afin de le faire fonctionner, il faut lui donner une recette. En ex\xe9cutant la commande \"capify .\", Capistrano vous a cr\xe9\xe9 un fichier ",(0,r.jsx)(n.strong,{children:"Capifile"})," et un r\xe9pertoire ",(0,r.jsx)(n.strong,{children:"config"})," avec ",(0,r.jsx)(n.strong,{children:"deploy.rb"})," \xe0 l'int\xe9rieur. C'est ce dernier qui va donner la recette de votre d\xe9ploiement \xe0 Capistrano."]}),"\n",(0,r.jsx)(n.p,{children:"Dans ce fichier, vous pouvez absolument tout faire en d\xe9finissant des param\xe8tres et en ex\xe9cutant des lignes de commandes dans un ordre d\xe9fini."}),"\n",(0,r.jsx)(n.h2,{children:"Ma m\xe9thode"}),"\n",(0,r.jsxs)(n.p,{children:["Le script que je vais vous pr\xe9senter est utilisable pour la plupart des CMS PHP, du type Wordpress, utilisant une base de donn\xe9es. Avec quelques ajustements, il peut tr\xe8s bien \xeatre utilis\xe9 pour un site statique ou que sais-je encore. Donc tout d'abord dans ",(0,r.jsx)(n.strong,{children:"Capfile"})," :"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ruby",children:"require 'rubygems'\nrequire 'railsless-deploy'\nload 'config/deploy.rb' if respond_to?(:namespace)\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Puis dans ",(0,r.jsx)(n.strong,{children:"deploy.rb"}),", on commence par d\xe9finir nos param\xe8tres serveur :"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ruby",children:'# SERVER (exemple user@user.hostingservice.com)\nset :domain,  "user.hostingservice.com"\nset :user,    "user"\n\n# NAME\nset :application, "monApplication"\n'})}),"\n",(0,r.jsx)(n.p,{children:"Ensuite, on va d\xe9finir les param\xe8tres li\xe9s \xe0 notre repository Git :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ruby",children:'# REPOSITORY (exemple avec un repo Bitbucket)\nset :repository, "git@bitbucket.org:User/application-name.git"\nserver "#{domain}", :app, :web, :db, :primary => true\nset :deploy_via, :copy\nset :copy_exclude, [".git", ".DS_Store"]\nset :scm, :git\nset :branch, "master"\n'})}),"\n",(0,r.jsx)(n.p,{children:"Puis les param\xe8tres li\xe9s au d\xe9ploiement :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ruby",children:'# DEPLOY PARAMETERS\nset :deploy_to, "/home/user/webapps/#{application}"\nset :use_sudo, false\nset :git_shallow_clone, 1\nset :keep_releases, 10\nssh_options[:paranoid] = false\n'})}),"\n","\n",(0,r.jsx)(n.p,{children:"Et pour finir, les param\xe8tres li\xe9s \xe0 la base de donn\xe9es :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ruby",children:'# DATABASE\nset :dump_name, "dump.#{Time.now.strftime \'%Y%m%d%H%M%S\'}.sql"\nset :dbuser, "remote_user" \nset :dbhost, "server.hostingservice.com"\nset :dbpassword, "PASSWORD"\nset :application_db, "remote_db_name"\nset :local_db_host, "localhost"\nset :local_db_user, "root"\nset :local_db_password, ""\nset :local_db, "local_db_name"\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Ensuite, on va cr\xe9er des fonctions de d\xe9ploiement en commen\xe7ant par celle qui enverra les fichiers et qui installera votre fichier de config, ici ",(0,r.jsx)(n.strong,{children:"db.php.dist"})," qui va remplacer ",(0,r.jsx)(n.strong,{children:"db.php"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ruby",children:'namespace :deploy do\n  desc <<-DESC\n  A macro-task that updates the code and fixes the symlink.\n  DESC\n  task :default do\n    transaction do\n      update_code\n      symlink\n    end\n  end\n\n  task :update_code, :except => { :no_release => true } do\n    on_rollback { run "rm -rf #{release_path}; true" }\n    strategy.deploy!\n  end\n\n  desc "Set config file"\n  task :config_file do\n    run "rm #{release_path}/cms/config/db.php"\n    run "cp #{release_path}/cms/config/db.php.dist #{release_path}/anchor/config/db.php"\n    run "rm #{release_path}/cms/config/db.php.dist"\n  end\nend\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Nous allons ensuite nous occuper de la fonction qui va migrer votre base de donn\xe9es vers la base de donn\xe9es distante. Cette fonction est tr\xe8s simple : elle va cr\xe9er un Dump dans le r\xe9pertoire ",(0,r.jsx)(n.strong,{children:"dump/"})," (qu'il faudra pr\xe9alablement cr\xe9er) avec la date extacte afin d'avoir un fichier unique, puis va l'envoyer via SSH sur le MYSQL de votre serveur. J'ai pris le parti de ne pas supprimer les Dumps afin de garder un versionnement de ma DB, mais libre \xe0 vous de les supprimer. Dans tous les cas, je vous conseille de ne pas les commiter sur votre repo Git."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ruby",children:'namespace :db do\n  desc "Clone local DB to remote"\n  task :migrate do\n    system "mysqldump -u #{local_db_user} -B #{local_db} > dump/#{dump_name}"\n    system "ssh -C #{user}@#{domain} mysql -u #{dbuser} --password=#{dbpassword} #{application_db} < dump/#{dump_name}"\n  end\nend\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Pour en finir avec ",(0,r.jsx)(n.strong,{children:"deploy.rb"}),", il faut encore d\xe9finir quelles fonctions vont \xeatre execut\xe9, et dans quel ordre."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ruby",children:'#En premier nous allons migrer la base de donn\xe9es\nbefore "deploy:update_code", "db:migrate"\n\n#Puis apr\xe8s l\'envoi des fichiers, installer le fichier de config\nafter "deploy:update_code", "deploy:config_file"\n\n#Pour finir, supprimer les veilles releases selon -> set :keep_releases\nafter "deploy:update_code", "deploy:cleanup"\n'})}),"\n",(0,r.jsx)(n.h2,{children:"Enfin le d\xe9ploiement !"}),"\n",(0,r.jsx)(n.p,{children:"Maintenant que la recette est \xe9crite, il ne reste plus qu'\xe0 d\xe9ployer. Au premier d\xe9ploiement et pour cr\xe9er les diff\xe9rents r\xe9pertoires:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ cap deploy:setup\n"})}),"\n",(0,r.jsx)(n.p,{children:"Ensuite la commande magique pour chaque mise \xe0 jour :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ cap deploy:setup\n"})}),"\n",(0,r.jsx)(n.p,{children:"Et selon ma recette, si vous souhaitez seulement migrer la base de donn\xe9es:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ cap db:migrate\n"})}),"\n",(0,r.jsx)(n.p,{children:"Un probl\xe8me ?"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ cap deploy:rollback\n"})}),"\n",(0,r.jsx)(n.h2,{children:"Hum... le site ne marche pas !"}),"\n",(0,r.jsxs)(n.p,{children:["Et c'est normal, car comme je vous l'ai expliqu\xe9 plus haut, il vous faut encore param\xe9trer le serveur pour qu'il pointe sur ",(0,r.jsx)(n.strong,{children:"current"})," afin d'ex\xe9cuter la bonne release. Donc pour cela, cr\xe9ez un ",(0,r.jsx)(n.strong,{children:".htaccess"})," \xe0 la racine:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"<IfModule mod_rewrite.c>\n    RewriteEngine on\n    RewriteCond %{REQUEST_URI} !^/current\n    RewriteRule ^(.*)$ /current/$1 [L]\n</IfModule>\n"})}),"\n",(0,r.jsx)(n.h2,{children:"Conclusion"}),"\n",(0,r.jsxs)(n.p,{children:["Capistrano est ",(0,r.jsx)(n.strong,{children:"LA"})," solution qui simplifiera votre vie et dont vous ne pourrez plus vous passer. Malgr\xe9 les pr\xe9requis n\xe9cessaires, c'est un outil qui se prend vite en main et qui, malgr\xe9 le temps d'apprentissage, vous fera gagner un temps consid\xe9rable dans tous vos projets."]}),"\n",(0,r.jsxs)(n.p,{children:["N'h\xe9sitez pas si vous avez une question et pour ceux qui souhaiterais en savoir plus:",(0,r.jsx)("br",{}),"\n",(0,r.jsx)(n.a,{href:"https://github.com/capistrano/capistrano/wiki",children:"Le Wiki officiel"}),(0,r.jsx)("br",{}),"\n",(0,r.jsx)(n.a,{href:"http://capifony.org/",children:"Pour Symfony2"}),(0,r.jsx)("br",{}),"\n",(0,r.jsx)(n.a,{href:"http://ryanflorence.com/deploying-with-capistrano-without-rails/",children:"Un excellent article"})]})]})}function c(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,r.jsx)(l,{...e,children:(0,r.jsx)(o,{...e})})}},62090:function(e,n,s){"use strict";s.d(n,{Z:function(){return c}});var r=s(85893);s(67294);var i=s(90512),t=s(41664),a=s.n(t),l=s(68658),o=s(81612),c=e=>{let{crumbs:n}=e;return(0,r.jsx)("nav",{"aria-label":"breadcrumb",className:"mb-6 transform md:translate-x-1 md:mb-0",children:(0,r.jsxs)("ol",{className:"inline-flex text-sm text-gray-600 lowercase md:text-lg opacity-60 hover:opacity-100 duration-500 transition-opacity transform md:-translate-x-full md:translate-y-2 md:-rotate-90 md:origin-right",children:[(0,r.jsx)("li",{children:(0,r.jsxs)(a(),{href:"/",className:"link",children:[(0,r.jsx)("span",{className:"sr-only",children:"Homepage"}),(0,r.jsx)(o.Z,{name:"tipi",className:"text-base md:text-lg"})]})}),n.map((e,n)=>{let{href:s,label:t}=e;return(0,l.Z)(s)?(0,r.jsxs)("li",{"aria-current":"page",children:[(0,r.jsx)("span",{className:"px-3","aria-hidden":!0,children:"\xb7"}),(0,r.jsx)("span",{className:(0,i.Z)("inline-block truncate",{maxWidth:250}),children:t})]},"crumb-".concat(n)):(0,r.jsxs)("li",{children:[(0,r.jsx)("span",{className:"px-3","aria-hidden":!0,children:"\xb7"}),(0,r.jsx)(a(),{href:s,className:"link",children:t})]},"crumb-".concat(n))})]})})}},47439:function(e,n,s){"use strict";s.d(n,{Z:function(){return u}});var r=s(85893);s(67294);var i=s(47906),t=s(63595),a=s(62090),l=s(73574),o=s(29454),c=s(53659),d=s(8523),p=s(35045),u=e=>{let{children:n,meta:s}=e;return(0,r.jsxs)(c.Z,{outsideChildren:(0,r.jsx)(d.Z,{}),children:[(0,r.jsx)(p.Z,{title:s.title,description:s.description}),(0,r.jsx)(a.Z,{crumbs:[{href:"/blog",label:"Blog"},{label:s.title}]}),(0,r.jsxs)("article",{className:"w-full mx-auto mt-20 sm:w-10/12 md:w-2/3 xl:w-7/12 md:px-8",children:[(0,r.jsxs)(o.Z,{move:!1,children:[(0,r.jsx)("h1",{className:"text-3xl font-medium text-gray-900 md:text-4xl lg:text-5xl",children:s.title}),(0,r.jsx)(l.Z,{children:(0,r.jsxs)("h2",{className:"font-medium md:text-lg",children:[(0,r.jsx)("span",{children:"Yann Gouffon — "}),(0,i.WU)((0,t.D)(s.date),"PPP")]})})]}),(0,r.jsx)(o.Z,{className:"mt-16 font-serif text-lg text-gray-900 space-y-6 md:mt-14 prose-headings:pt-4 prose-p:leading-[1.618em] lg:text-xl xl:text-2xl xl:prose-p:leading-[1.618em] prose-a:text-blue prose-headings:font-sans prose-headings:font-medium prose-h2:text-[26px] xl:prose-h2:text-[28px] prose-h3:text-[19px] lg:prose-h3:text-[24px] xl:prose-h3:text-[27px] prose-h4:text-[18px] lg:prose-h4:text-[21px] xl:prose-h4:text-[25px] prose-strong:text-medium prose-ul:list-disc prose-ul:pl-3 prose-ul:space-y-3 prose-ul:leading-[1.618em] xl:prose-figure:w-[106%] xl:prose-figure:-translate-x-[2.8%] prose-figure:rounded-lg prose-figure:overflow-hidden prose-figure:my-8",children:n})]})]})}}},function(e){e.O(0,[1635,9757,3880,520,5098,7539,8523,2888,9774,179],function(){return e(e.s=9549)}),_N_E=e.O()}]);